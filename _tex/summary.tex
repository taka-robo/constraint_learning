\documentclass[11pt]{article}

%\input{pandoc-preamble.tex}

\usepackage{parskip} % Stop auto-indenting (to mimic markdown behaviour)

\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage{amsmath} 
\usepackage{amssymb} 
\usepackage{xcolor} 
\usepackage{enumerate} 
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\usepackage{placeins} % for Flaotbarrier

\title{Constraints Learning}

% Setup hyperref package
\hypersetup{
  breaklinks=true,  % so long urls are correctly broken across lines
  colorlinks=true,
  urlcolor=urlcolor,
  linkcolor=linkcolor,
  citecolor=citecolor,
  }
% Slightly bigger margins than the latex defaults

\geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}

\usepackage{bm}
\newcommand{\vc}[1]{\ensuremath{\bm{#1}}}
  
  

\usepackage{draftfigure}
\begin{document}
  
\maketitle
  
\section{Constraints Learning}\label{constraints-learning}

Assume you have an optimization problem written in terms of
\(\vc{\theta}\):

\(\min_{\vc{\theta}} f(\vc{\theta})\)

where \(f\) maybe be for instance a polynomial or a rationial function,
and \(\theta \in \mathbb{R}^N\) may be multidimensional. We assume that
you can write the above problem in an quivalent QCQP form by using a
``lifting function'' \(\vc{l}(\theta) \in \mathbb{R}^M\) and
defining the hihger-dimensional lifted state vector

\(\vc{x}(\theta) = \begin{bmatrix}1 \\ \theta \\ z_1 \\ \vdots \\ z_M \end{bmatrix} = \begin{bmatrix}1 \\ \theta \\ \vc{l}(\theta) \end{bmatrix} \in \mathbb{R}^{1+N+M}\)

Now we assume that each of the added constraints can itself be written
as a quadratic function:

\(l_m(\theta) - z_m = \vc{x}(\theta)^\top \vc{A}_m \vc{x}(\theta) = 0\)

where \(\vc{A}_m\) (\(m=1\ldots M\)) are the constraints matrices.
Sometimes, there may also exist redundant constraints, meaning some
other matrices such that

\(\vc{x}(\theta)^\top \vc{B}_m \vc{x}(\theta) = 0\).

The goal of this not is to, for a given lifting function
\(\vc{l}(\theta)\), find the form of the redundant vs.~primal
constraints.

\textbf{note that currently we just find all constraints and don't
distinguish between primal (moment) constraints and redundant
constraints}

\subsection{Learning constraints matrices}

The idea is to learn the nullspace of the matrix composed of many
randomly generated feasible and lifted points:\\
Call \(\vc{x}_{i}\) the \(i\)-th randomly generated setup, then we
know that

\(\forall i, m: \quad \text{trace}(\vc{x}_{i}{\vc{x}_{i}}^\top\vc{A}_m) = 0\)

\(\iff\)

\(\forall i, m: \quad \underbrace{\text{vec}(\vc{X}_{i})^\top}_{\vc{y}_{i}^\top} \underbrace{\text{vec}(\vc{A}_m)}_{\vc{a}_m} = 0\)

\(\iff\)

\(\vc{a}_m \in \mathcal{N}(\vc{Y}), \quad \vc{Y} = \begin{bmatrix} \vc{y}_1^{\top} \\ \vdots \\ \vc{y}_L^{\top}\end{bmatrix}\)

where \(L\) is the number of samples. Note that we can reduce the search
to the upper triangular part of \(\vc{A}_m\) since we know that
resulting matrix needs to be symmetric, but for simplicity we write
everything in terms of the full matrix below. We find an orthonormal
basis of the nullspace using SVD or QR decomposition, and then construct
\(\vc{A}_m\) by undoing the (half-)vec operation.

We call \(N_0\) the dimension of the nullspace, or the number of basis
vectors found.

\subsection{Solve dual problem}

Using the learned matrices, we solve the dual problem

\begin{align} 
d_n^* = &\max_{\rho, \vc{\lambda}} -\rho \\
&\text{s.t. } \vc{Q} + \sum_{m=1}^n \lambda_m \vc{A}_m + \rho \vc{A}_0 \succeq 0
\end{align}

where \(n \leq N_0\) denotes the number of constraints we are adding and
compare the obtained cost to the cost of the (hopefully globally
optimal) solution obtain by solving the original problem with a simple
local solver:

\begin{align}
q^* &= \min_{\vc{\theta}} f(\vc{\theta})
\end{align}


\section{Lifting functions}

Currently implemented setups:

Poly4Lifter:

\begin{itemize}
\tightlist
\item univariate quartic polynomial
\item \(\vc{x}^\top = [1, t, \underbrace{t^2}_{z}]\)
\item no redundant constraints
\end{itemize}

Poly6Lifter:
\begin{itemize}
\tightlist
\item univariate sectic polynomial
\item \(\vc{x}^\top = [1, t, \underbrace{t^2}_{z_1}, \underbrace{t^3}_{z_2}]\)
\item leads to one redundant constraints
\end{itemize}

RangeOnlyLifter:

\begin{itemize}
\tightlist
\item \(N\) positions in \(d\) dimensions
\item \(\vc{x}^\top = [1, \vc{x}_1, \vc{x}_2, \cdots , \underbrace{||\vc{x}_1||^2}_{z_1}, \underbrace{||\vc{x}_2||^2}_{z_2}, \cdots]\)
\item \(N\) moment constraints, no redundant constraints
\end{itemize}

PoseLandmarkLifter:

\begin{itemize}
\tightlist
\item \(K\) landmarks \(\vc{y}_k\), \(N\) poses in \(d\) dimensions
\item \(\vc{x}^\top = [1, \vc{x}_1, \text{vec}(\vc{C}_1), \vc{y}_1, \cdots , \underbrace{\vc{C}_1\vc{y_1}}_{\vc{z}_1}, \underbrace{\vc{C}_2\vc{y_1}}_{\vc{z}_2}, \cdots]\)
\item \(KNd + Nd^2\) moment constraints, many redundant constraints
\end{itemize}

Stereo1DLifter:

\begin{itemize}
\tightlist
\item \(K\) landmarks \(y_k\), 1 position in 1 dimensions (\(\theta=x\))
\item \(\vc{x}^\top = [1, x, \underbrace{\frac{1}{x-y_1}}_{z_1}, \cdots, \underbrace{\frac{1}{x-y_K}}_{z_K}]\) 
\item \(K\) moment constraints, \(K(K-1)/2\) redundant constraints
\end{itemize}

Stereo2DLifter:

\begin{itemize}
\tightlist
\item \(K\) landmarks \(\vc{y}_k\), 1 pose in 2 dimensions (\(\vc{\theta}=(x, y, \alpha)\), or equivalently transform matrix \(\vc{T}=\begin{bmatrix} \vc{c}_1(\alpha) & \vc{c}_2(\alpha) & \begin{bmatrix} x \\ y \end{bmatrix} \\ 0 & 0 & 1 \end{bmatrix}\))
\item \(\vc{x}^\top = \begin{bmatrix} 1, \vc{c}_1, \vc{c}_2, x, y, \underbrace{\frac{1}{\vc{e}_y^\top\vc{T}{y}_1}\vc{T}\vc{y}_1}_{z_1}, \cdots, \underbrace{\frac{1}{\vc{e}_y^\top\vc{T}{y}_K}\vc{T}\vc{y}_K}_{z_K}\end{bmatrix}\)
\end{itemize}

with \(\vc{e}_y\) the second vector of the 3d identity matrix.

\newpage
\FloatBarrier
\section{Analysis}

\begin{figure}[h]
  \centering
  \includegraphics[width=.4\linewidth]{../_plots/study_stereo1d_no.png} \\
  \includegraphics[width=.4\linewidth]{../_plots/study_stereo2d_no.png} 
  \includegraphics[width=.4\linewidth]{../_plots/study_stereo2d_urT.png} \\
  \includegraphics[width=.4\linewidth]{../_plots/study_stereo3d_no.png} 
  \includegraphics[width=.4\linewidth]{../_plots/study_stereo3d_urT.png}
  \label{fig:noise}
\end{figure}


\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{../_plots/stereo_study_noise_1d_0level.png}
  \includegraphics[width=\linewidth]{../_plots/stereo_study_noise_2d_0level.png}
  \includegraphics[width=\linewidth]{../_plots/stereo_study_noise_2d_3level.png}
  \includegraphics[width=\linewidth]{../_plots/stereo_study_noise_3d_0level.png}
  \setdf{content={3d with urT missing because too slow}}
  \includegraphics[width=\linewidth,draft=true]{../_plots/stereo_study_noise_3d_3level.png}
  \label{fig:noise}
\end{figure}

\clearpage
\FloatBarrier
\section{All plots}

\begin{figure}[h!]
  \centering
  \textbf{\large{Stereo1D no Lasserre}} \\
  \vspace{2em}
  \includegraphics[height=3cm]{../_plots/svd_stereo1d.png}
  \includegraphics[height=3cm]{../_plots/Q_stereo1d.png}
  \includegraphics[width=.7\linewidth]{../_plots/A0_stereo1d.png}
  \includegraphics[width=.6\linewidth]{../_plots/tightness_stereo1d.png}
  \label{fig:noise}
\end{figure}

\begin{figure}[h!]
  \centering
  \textbf{\large{Stereo2D no Lasserre}} \\
  \vspace{2em}
  \includegraphics[height=3cm]{../_plots/svd_stereo2d_no.png}
  \includegraphics[height=3cm]{../_plots/Q_stereo2d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A0_stereo2d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A1_stereo2d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A2_stereo2d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A3_stereo2d_no.png}
  \includegraphics[width=.6\linewidth]{../_plots/tightness_stereo2d_no.png}
  \label{fig:noise}
\end{figure}

\begin{figure}[h]
  \centering
\textbf{\large{Stereo2D with Lasserre, $\vc{p}\vc{z}_j^\top$}} \\
  \vspace{2em}
  \includegraphics[height=3cm]{../_plots/svd_stereo2d_urT.png}
  \includegraphics[height=3cm]{../_plots/Q_stereo2d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A0_stereo2d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A1_stereo2d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A2_stereo2d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A3_stereo2d_urT.png}
  \includegraphics[width=.6\linewidth]{../_plots/tightness_stereo2d_urT.png}
  \label{fig:noise}
\end{figure}


\begin{figure}[h]
  \centering
  \textbf{\large{Stereo3D no Lasserre}} \\
  \vspace{2em}
  \includegraphics[height=3cm]{../_plots/svd_stereo3d_no.png}
  \includegraphics[height=3cm]{../_plots/Q_stereo3d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A0_stereo3d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A1_stereo3d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A2_stereo3d_no.png}
  \includegraphics[width=.9\linewidth]{../_plots/A3_stereo3d_no.png}
  \includegraphics[width=.6\linewidth]{../_plots/tightness_stereo3d_no.png}
  \label{fig:noise}
\end{figure}

\begin{figure}[h]
  \centering
  \textbf{\large{Stereo3D with Lasserre}} \\
  \vspace{2em}
  \includegraphics[height=3cm]{../_plots/svd_stereo3d_urT.png}
  \includegraphics[height=3cm]{../_plots/Q_stereo3d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A0_stereo3d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A1_stereo3d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A2_stereo3d_urT.png}
  \includegraphics[width=.9\linewidth]{../_plots/A3_stereo3d_urT.png}
  \includegraphics[width=.6\linewidth]{../_plots/tightness_stereo3d_urT.png}
  \label{fig:noise}
\end{figure}



\begin{figure}[h]
  \centering
  \textbf{\large{Stereo2D with Lasserre, different lifting functions}}\\
  original \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_no.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo2d_no.png} \\
  $\vc{p}\vc{z}_j^\top$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_urT.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo2d_urT.png} \\
  $\vc{p}^\top\vc{z}_j$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_u@r.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo2d_u@r.png} \\
  $\vc{p}^\top\vc{p}$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_r@r.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo2d_r@r.png} \\
  $\vc{p}\circ\vc{p}$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_r2.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo2d_r2.png}  \\
  $\vc{p}\vc{p}^\top$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_rrT.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo2d_rrT.png}  \\
  $\vc{z}_j\circ\vc{z}_j$ \\
  \setdf{content={no nullspace}}
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_u2.png} 
  \includegraphics[width=.85\linewidth,height=1cm,draft=True]{example-image-c}  \\
  $\vc{z}_j^\top\vc{z}_j$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo2d_u@u.png}
  \includegraphics[width=.85\linewidth,height=1cm,draft=True]{example-image-c}  \\
\end{figure}

\begin{figure}[h]
  \centering
  \textbf{\large{Stereo3D with Lasserre, different lifting functions}}\\
  original \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_no.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo3d_no.png} \\
  $\vc{p}\vc{z}_j^\top$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_urT.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo3d_urT.png} \\
  $\vc{p}^\top\vc{z}_j$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_u@r.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo3d_u@r.png} \\
  $\vc{p}^\top\vc{p}$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_r@r.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo3d_r@r.png} \\
  $\vc{p}\circ\vc{p}$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_r2.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo3d_r2.png}  \\
  $\vc{p}\vc{p}^\top$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_rrT.png}
  \includegraphics[width=.85\linewidth]{../_plots/A0_stereo3d_rrT.png}  \\
  $\vc{z}_j\circ\vc{z}_j$ \\
  \setdf{content={no nullspace}}
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_u2.png} 
  \includegraphics[width=.85\linewidth,height=1cm,draft=True]{example-image-c}  \\
  $\vc{z}_j^\top\vc{z}_j$ \\
  \includegraphics[width=.14\linewidth]{../_plots/svd_stereo3d_u@u.png}
  \includegraphics[width=.85\linewidth,height=1cm,draft=True]{example-image-c}  \\
\end{figure}

\end{document}
